slug: credentials-not-secrets
ordering: 2
prerequisiteGuideSlugs:
  - "ground-control-first-stack"
metadata:
  title: "Credentials, Not Secrets - AWS Integration"
  description: "Connect to AWS securely using cross-account role assumption instead of static credentials"
  labels: ["aws", "integration", "security", "iam", "cloud-credentials"]
  difficulty: "easy"
  minutesToComplete: 25
  prerequisites:
    - "You should have completed the 'Ground Control' guide and have a working stack"
    - "You need an AWS account with permissions to create IAM roles"
    - "Basic understanding of AWS IAM concepts is helpful but not required"

steps:
  - order: 1
    title: "Open Spacelift AWS Integration Setup Page"
    instruction: |
      1. Go to [Integrate services > Integrations](/integrations).
      2. Look for the **AWS** tile and click **View**, then click **Set up integration**.
      3. Name it '${aws_integration_name}'.
      4. Keep this tab open - at the bottom of the page, you'll see the exact **trust policy JSON** that AWS needs. You'll copy this in the next step.
    hint: "The Spacelift UI shows you the exact trust policy to use, including the correct account ID and external ID. This eliminates manual configuration errors and ensures the trust relationship is set up correctly."

  - order: 2
    title: "Create IAM Role in AWS with Trust Policy"
    instruction: |
      1. Open a new browser tab and log into your AWS Console.
      2. Navigate to IAM > Roles > **Create role**.
      3. Select **Custom trust policy** as the trusted entity type.
      4. Copy the trust policy JSON from the Spacelift integration setup page and paste it into the policy editor.
      5. Click **Next**.
    hint: "Using 'Custom trust policy' lets you paste the exact JSON from Spacelift. This includes the external ID which prevents the 'confused deputy' problem - ensuring only your Spacelift account can assume this role."

  - order: 3
    title: "Attach Permissions to IAM Role"
    instruction: |
      1. On the permissions page, search for and attach these two managed policies:
         - **AmazonS3FullAccess** (for S3 bucket management)
         - **AmazonEC2FullAccess** (for VPC, subnet, and security group management)
      2. Name your role 'spacelift-orbit-labs-role'.
      3. Add description: 'Role for Spacelift to manage AWS infrastructure'.
      4. Click **Create role**.
      5. After creation, click on the role name and copy the **Role ARN** from the summary section.
    hint: "We're attaching specific policies for the resources you'll create in upcoming guides. For production, use even more restrictive custom policies tailored to your exact needs."

  - order: 4
    title: "Complete Integration Setup in Spacelift"
    instruction: |
      1. Return to the Spacelift browser tab with the integration setup page.
      2. Paste the IAM role ARN into the **Role ARN** field.
      3. Click **Set up** to create the integration.
    hint: "The integration doesn't store any credentials - it just stores the role ARN and external ID. When your stack runs, Spacelift will dynamically assume this role to get temporary credentials. This is much more secure than storing access keys!"
    validationHint: "You can proceed to the next step once your AWS integration is set up."
    validation: |
      package spacelift

      valid if {
        some integration in input.aws_integrations
        integration.name == input.expectations.aws_attachment_name
      }

  - order: 5
    title: "Attach Integration to Your Stack"
    instruction: |
      1. Navigate to your stack (${main_stack_name}).
      2. Go to **Settings** > **Cloud integrations**.
      3. Click **Attach integration** and select your '${aws_integration_name}' integration from the dropdown.
      4. Enable both **Read** and **Write** permissions for the integration.
      5. Click **Attach**.
    hint: "Attaching the integration to the stack tells Spacelift to use these credentials when running this stack. You can attach different integrations to different stacks for separation of concerns."
    validationHint: "Before moving on, make sure the integration is attached to your stack."
    validation: |
      package spacelift

      main_stack := stack if {
        some stack in input.stacks
        stack.name == input.expectations.main_stack_name
      }

      valid if {
        some attachment in input.aws_attachments
        attachment.name == input.expectations.aws_attachment_name
        attachment.attached_to == main_stack.id
      }

  - order: 6
    title: "Update Your Terraform Code"
    instruction: |
      In your repository (${main_stack_name}), edit main.tf to add the AWS provider and a data source alongside your existing random_pet resource:
      ```language-hcl
      terraform {
        required_providers {
          aws = {
            source  = "hashicorp/aws"
            version = "~> 6.0"
          }
        }
      }

      provider "aws" {
        region = "us-east-1"
      }

      data "aws_caller_identity" "current" {}

      output "aws_account_id" {
        value = data.aws_caller_identity.current.account_id
      }
      ```
      Commit and push. This will automatically trigger a run in Spacelift.
    hint: "The aws_caller_identity data source is perfect for testing - it just tells you who you are in AWS (your account ID). Watch the run progress through initialization and planning. If you see authentication errors, double-check your role ARN and trust policy."
    validationHint: "You can proceed to the next step once the push triggers a new run on your stack."
    validation: |
      package spacelift

      main_stack := stack if {
        some stack in input.stacks
        stack.name == input.expectations.main_stack_name
      }

      tracked_runs contains run if {
        some run in input.runs
        run.stack_id == main_stack.id
        run.type == "TRACKED"
      }

      valid if {
        count(tracked_runs) >= 2
      }

  - order: 7
    title: "Confirm Plan and Apply"
    instruction: |
      1. After planning completes, review the plan. Since we only added a data source (which just queries AWS) and kept the random_pet resource, you should see 0 changes but 1 resource to refresh (the data source).
      2. Click **Confirm** to apply.
      3. The run should complete quickly.
    hint: "Data sources don't create infrastructure - they just read information. This is perfect for testing credentials without actually creating any AWS resources (and avoiding any costs!)."
    validationHint: "Confirm and apply the run before moving on."
    validation: |
      package spacelift

      main_stack := stack if {
        some stack in input.stacks
        stack.name == input.expectations.main_stack_name
      }

      unconfirmed_runs contains run if {
        some run in input.runs
        run.stack_id == main_stack.id
        run.status == "UNCONFIRMED"
      }

      valid if {
        count(unconfirmed_runs) == 0
      }

  - order: 8
    title: "Verify AWS Access in Outputs"
    instruction: |
      1. After the run finishes, scroll to the **Outputs** section.
      2. You should see 'aws_account_id' output showing your AWS account ID.
      3. This confirms that Spacelift successfully assumed your IAM role and made an authenticated call to AWS!
    hint: "Success! You've just configured secure, temporary credential access to AWS. No access keys stored anywhere, no secrets to rotate - just secure role assumption. This is the foundation for all your AWS infrastructure management in Spacelift. Your AWS account ID in the output is proof that the integration works!"

completion:
  successMessage: "Excellent! You've configured secure AWS access using IAM role assumption - no static credentials stored, no secrets to rotate. This pattern scales to production with different roles for different environments and least-privilege permissions. Orbit Labs is ready to deploy real AWS infrastructure!"
  recommendedGuideIds: ["first-launch"]
